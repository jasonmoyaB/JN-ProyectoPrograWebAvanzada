@model IEnumerable<JN_ProyectoPrograAvanzadaWeb_G1.Models.Usuario>
@using System.Globalization

@{
    ViewData["Title"] = "Reportes KPI - Auditoría";

    var usuarios = Model ?? Enumerable.Empty<JN_ProyectoPrograAvanzadaWeb_G1.Models.Usuario>();

    var totalUsuarios = usuarios.Count();
    var activos = usuarios.Count(u => u.Activo);
    var inactivos = totalUsuarios - activos;

    var usuariosPorRol = usuarios
        .GroupBy(u => u.Rol?.NombreRol ?? "Sin rol")
        .Select(g => new { Nombre = g.Key, Cantidad = g.Count() })
        .OrderByDescending(x => x.Cantidad)
        .ToList();

    var hoy = DateTime.UtcNow;
    var meses = Enumerable.Range(0, 6)
        .Select(i => hoy.AddMonths(-i))
        .Reverse()
        .Select(d => new DateTime(d.Year, d.Month, 1))
        .ToList();

    var registrosPorMes = meses
        .Select(m => new
        {
            Mes = m.ToString("MMM yyyy", CultureInfo.InvariantCulture),
            Cantidad = usuarios.Count(u => u.FechaRegistro >= m && u.FechaRegistro < m.AddMonths(1))
        })
        .ToList();
}

<div class="container mt-4">
    <h2 class="mb-4">
        <i class="fa-solid fa-chart-line text-primary me-2"></i> Reportes KPI - Auditoría
    </h2>

    <!-- TARJETAS KPI -->
    <div class="row g-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h5 class="card-title">Usuarios Totales</h5>
                    <p class="display-6 text-primary">@totalUsuarios</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h5 class="card-title">Activos</h5>
                    <p class="display-6 text-success">@activos</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h5 class="card-title">Inactivos</h5>
                    <p class="display-6 text-danger">@inactivos</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h5 class="card-title">Roles Registrados</h5>
                    <p class="display-6 text-info">@usuariosPorRol.Count()</p>
                </div>
            </div>
        </div>
    </div>

    <!-- GRaFICO + ROLES -->
    <div class="row mt-5">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5>Registros últimos 6 meses</h5>
                    <canvas id="chartRegs" height="120"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5>Usuarios por Rol</h5>
                    <ul class="list-group">
                        @foreach (var r in usuariosPorRol)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                @r.Nombre
                                <span class="badge bg-primary rounded-pill">@r.Cantidad</span>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA DETALLE -->
    <div class="card shadow-sm mt-5">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fa-solid fa-table me-1"></i> Detalle de Usuarios</h5>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Correo</th>
                            <th>Rol</th>
                            <th>Fecha Registro</th>
                            <th>Activo</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var u in usuarios)
                        {
                            <tr>
                                <td>@u.UsuarioID</td>
                                <td>@u.Nombre</td>
                                <td>@u.CorreoElectronico</td>
                                <td>@(u.Rol?.NombreRol ?? "-")</td>
                                <td>@u.FechaRegistro.ToString("yyyy-MM-dd")</td>
                                <td>
                                    @if (u.Activo)
                                    {
                                        <span class="text-success fw-bold">Sí</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger fw-bold">No</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <button class="btn btn-outline-primary" id="btnExportCsv">Exportar CSV</button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    var labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(registrosPorMes.Select(x => x.Mes)));
    var data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(registrosPorMes.Select(x => x.Cantidad)));

    (function () {
        var canvas = document.getElementById('chartRegs');
        if (!canvas) return;

        var ctx = canvas.getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Registros',
                    data: data,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });

        // Export CSV
        var btn = document.getElementById('btnExportCsv');
        if (btn) {
            btn.addEventListener('click', function () {
                var table = document.querySelector('table');
                if (!table) return;
                var rows = Array.from(table.querySelectorAll('tr'));
                var csv = rows.map(function (row) {
                    var cells = Array.from(row.querySelectorAll('th, td'));
                    return cells.map(function (c) {
                        var txt = c.innerText.replace(/"/g, '""');
                        if (txt.search(/,|\n|"/) >= 0) txt = '"' + txt + '"';
                        return txt;
                    }).join(',');
                }).join('\n');

                var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'usuarios_reportes_kpi.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
    })();
</script>
